# DATA_CONTRACT（W1–W2）
更新日: 2026-02-18（JST）

本書は、W1–W2の実装で守るデータ契約（Data Contract）の唯一の基準である。
実装・テスト・運用のいずれも本書を優先し、曖昧な解釈を禁止する。

---

## 1. 適用範囲
- 対象: FX価格データの入力、正規化、リサンプル、品質検査。
- 目的: 同一入力から同一出力を再現可能にし、後続Issue（Loader/Resample/Quality/Manifest）の前提を固定する。

---

## 2. 最小スキーマ
以下の列を最小必須とする。

| 列名 | 型（推奨） | 必須 | 意味 |
|---|---|---|---|
| `symbol` | string | 必須 | 通貨ペア識別子（例: `USDJPY`） |
| `ts_utc` | datetime64[ns, UTC] | 必須 | 内部基準時刻（UTC固定） |
| `o` | float64 | 必須 | open |
| `h` | float64 | 必須 | high |
| `l` | float64 | 必須 | low |
| `c` | float64 | 必須 | close |
| `v` | float64 または int64 | 必須 | volume |
| `spread` | float64 | 必須 | スプレッド（暫定定義あり） |

補足:
- 実装は列順に依存してはならないが、出力時は上表順を推奨する。
- 追加列は許可するが、上記必須列の意味を上書きしてはならない。

---

## 3. タイムゾーン規約（厳守）
1. 入力の時刻列 `ts` は **tz-aware必須**。
   - naive timestamp（タイムゾーン情報なし）は **即時FAIL**。
2. 内部基準時刻は必ず `ts_utc`（UTC）を使う。
   - `ts_utc` 以外を内部計算の基準時刻にしてはならない。
3. JST等のローカル時刻が必要な場合は派生列として扱う。
   - 派生列は表示・分析補助専用であり、内部基準を変更してはならない。
4. 暗黙変換は禁止。
   - naive tsへのタイムゾーン付与、ローカル時刻の自動推定、環境依存TZ解釈は禁止。

---

## 4. 欠損規約
1. `ffill` / `bfill` は禁止。
2. 欠損値の扱いは次のどちらかのみ許可。
   - 破棄（W1推奨）
   - 欠損フラグ列を追加して保持
3. `v=0`（ゼロvolume）は欠損と同一視しない。
   - 必要に応じて「流動性低下」等の別フラグで扱う。
4. 数値列（`o,h,l,c,v,spread`）で数値変換不能値がある場合はFAIL。

---

## 5. リサンプル定義（固定）
時間足変換時の集約関数は以下で固定する。

- `open` = first
- `high` = max
- `low` = min
- `close` = last
- `v` = sum
- `spread`（暫定）= mean

### `drop_incomplete` の定義
- `drop_incomplete=True` の場合、末尾の未完バーを必ず破棄する。
- 未完バーとは、対象足の終端時刻を迎えていないため、将来データで値が変化し得るバーを指す。

補足:
- 欠損補完によるバー成立は認めない。
- `drop_incomplete=False` は研究用途のみを想定し、本番利用時は明示的な合意が必要。

---

## 6. 品質ゲート（最低条件）
最低限、以下を満たさないデータはFAILとする。

1. 時系列整合性
   - `ts_utc` は単調増加（strictly increasing）
   - `ts_utc` の重複0件
2. 値整合性
   - `high < low` を禁止
   - `v < 0` を禁止
   - `o,h,l,c,spread` の非数（NaN/inf）を禁止
3. 欠損率管理
   - 列別の欠損率を算出し、閾値超過でFAIL。
   - 暫定閾値（W1）: 必須列の欠損率が 0% 以外ならFAIL。

ログ/例外要件:
- FAIL時は「どのルール違反か」を一意に特定できるメッセージを出す。
- 原因を隠す包括例外は不可。

---

## 7. 禁止事項一覧
以下は実装・運用ともに禁止。

- `ffill` / `bfill` による欠損補完
- naive timestamp の受け入れ
- 暗黙TZ変換（自動推定・環境依存解釈）
- 未来参照（未確定バーを確定値として扱う）
- テスト無し実装のマージ

---

## 8. 再現性要件
- 同一入力に対し同一出力を生成できること。
- ファイル単位のsha256でbit一致を検証できること。
- 出力順序は安定化（ソート規則固定）すること。

---

## 9. 実装チェックリスト（W1–W2）
- [ ] Loaderでtz-aware検証（naiveはFAIL）
- [ ] `ts_utc` 生成・UTC正規化
- [ ] 数値変換失敗のFAIL
- [ ] `ts_utc` 重複FAIL
- [ ] Resampleが本書の集約定義と一致
- [ ] `drop_incomplete` の末尾未完バー破棄
- [ ] 品質ゲートのFAIL理由が一意
- [ ] pytestでDoDを証明

